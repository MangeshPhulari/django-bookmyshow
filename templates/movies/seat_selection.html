{% extends "users/basic.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-8 mb-2 mb-sm-0">
                            <h4 class="card-title">{{ theater.movie.name }}</h4>
                            <p class="card-text text-muted mb-1">
                                {{ theater.name }} | {{ theater.time|date:"D, d M Y, h:i A" }}
                            </p>
                            <p class="card-text"><strong>₹{{ theater.price }}</strong> per seat</p>
                        </div>
                        <div class="col-sm-4 text-sm-right">
                             
                        </div>
                    </div>
                     {% if error %}
                        <div class="alert alert-danger mt-3">{{ error }}</div>
                     {% endif %}
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-center mb-4">Select Your Seats</h5>
                    <div class="screen mb-4">Screen</div> 

                    <form action="{% url 'book_seats' theater.id %}" method="POST">
                        {% csrf_token %}
                        <div class="seat-map d-flex justify-content-center flex-wrap mb-4">
                            {% for seat in seats %}
                                {% if seat.status == 'BOOKED' %}
                                    <div class="seat sold" title="Sold">{{ seat.seat_number }}</div>
                                {% elif seat.status == 'RESERVED' %}
                                    {% if seat.reserved_by == request.user %}
                                        <div class="seat reserved-you">
                                            <input type="checkbox" name="seats" value="{{ seat.id }}" class="d-none seat-checkbox" id="seat-{{ seat.id }}" checked autocomplete="off">
                                            <label for="seat-{{ seat.id }}" class="seat-label" title="Reserved by You">{{ seat.seat_number }}</label>
                                        </div>
                                    {% else %}
                                        <div class="seat reserved-other" title="Reserved">{{ seat.seat_number }}</div>
                                    {% endif %}
                                {% else %}
                                    <div class="seat available">
                                        <input type="checkbox" name="seats" value="{{ seat.id }}" class="d-none seat-checkbox" id="seat-{{ seat.id }}" autocomplete="off">
                                        <label for="seat-{{ seat.id }}" class="seat-label" title="Available">{{ seat.seat_number }}</label>
                                    </div>
                                {% endif %}
                            {% empty %}
                                <p class="text-center w-100">No seats available for this showtime.</p>
                            {% endfor %}
                        </div>

                        <div class="d-flex justify-content-center flex-wrap mb-4 small text-muted">
                            <div class="d-flex align-items-center mr-3 mb-2"><div class="seat-legend available"></div><span class="ml-1">Available</span></div>
                            <div class="d-flex align-items-center mr-3 mb-2"><div class="seat-legend selected"></div><span class="ml-1">Selected</span></div>
                            <div class="d-flex align-items-center mr-3 mb-2"><div class="seat-legend reserved-you-legend"></div><span class="ml-1">Your Reservation</span></div>
                            <div class="d-flex align-items-center mr-3 mb-2"><div class="seat-legend reserved-other"></div><span class="ml-1">Reserved</span></div>
                            <div class="d-flex align-items-center mb-2"><div class="seat-legend sold"></div><span class="ml-1">Sold</span></div>
                        </div>

                        <div class="text-center">
                            <p id="price-info" class="font-weight-bold"></p>
                            <button type="submit" id="proceed-button" class="btn btn-danger btn-lg" disabled>
                                Pay ₹<span id="total-price">0.00</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
  /* Reduced max-width for better fit on small screens */
  .seat-map { max-width: 320px; margin-left: auto; margin-right: auto; }
  .seat, .seat-legend {
    width: 30px; height: 30px; /* Smaller seats */
    margin: 3px; /* Slightly less margin */
    display: inline-flex; align-items: center; justify-content: center;
    border-radius: 4px; font-size: 0.75rem; font-weight: bold;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    transition: background-color 0.2s, color 0.2s, transform 0.1s;
  }
  .seat-legend { width: 18px; height: 18px; }

  /* States */
  .seat.available { border: 1px solid #198754; color: #198754; background-color: #fff; cursor: pointer; }
  .seat.available:hover { background-color: #d1e7dd; }
  .seat-legend.available { border: 1px solid #198754; background-color: #fff; }

  .seat label.seat-label { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 0; border-radius: inherit; }

  input[type="checkbox"]:checked + label.seat-label { background-color: #198754; color: white; }
  .seat-legend.selected { background-color: #198754; }

  .seat.reserved-you { border: 1px solid #ffc107; background-color: #fff3cd; color: #664d03; cursor: pointer; }
  .seat.reserved-you:hover { background-color: #ffecb5; }
  .seat-legend.reserved-you-legend { border: 1px solid #ffc107; background-color: #fff3cd; }
  .seat.reserved-you input[type="checkbox"]:checked + label.seat-label { background-color: #ffc107; color: #343a40; border: 2px solid #e0a800; }

  .seat.reserved-other { border: 1px solid #6c757d; background-color: #e2e6ea; color: #495057; cursor: not-allowed; }
  .seat-legend.reserved-other { border: 1px solid #6c757d; background-color: #e2e6ea; }

  .seat.sold { border: 1px solid #adb5bd; background-color: #ced4da; color: #6c757d; cursor: not-allowed; }
  .seat-legend.sold { border: 1px solid #adb5bd; background-color: #ced4da; }

  .screen { margin: 20px auto; width: 80%; background-color: #343a40; height: 10px; border-radius: 5px 5px 0 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.2); position: relative; text-align: center; color: #6c757d; font-size: 0.8rem; padding-top: 15px; }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.seat-checkbox');
        const priceInfo = document.getElementById('price-info');
        const totalPriceSpan = document.getElementById('total-price');
        const proceedButton = document.getElementById('proceed-button');
        const seatPrice = parseFloat("{{ theater.price }}"); // Get price from context

        function updatePrice() {
            const selectedCheckboxes = document.querySelectorAll('.seat-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            const totalPrice = (selectedCount * seatPrice).toFixed(2);

            if (selectedCount > 0) {
                //priceInfo.textContent = `Selected Seats: ${selectedCount}`;
                totalPriceSpan.textContent = totalPrice;
                proceedButton.disabled = false;
            } else {
                //priceInfo.textContent = '';
                totalPriceSpan.textContent = '0.00';
                proceedButton.disabled = true;
            }
        }

        checkboxes.forEach(cb => {
            cb.addEventListener('change', updatePrice);
        });

        // Initial price calculation in case seats are pre-selected (reserved by user)
        updatePrice();
    });
</script>
{% endblock %}